---
title: "Disease investigated by ancestry"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data

```{r setup_2, message = FALSE, warning= FALSE}

library(dplyr)
library(ggplot2)

gwas_study_info = data.table::fread("data/gwas_catalog/gwas-catalog-v1.0.3-studies-r2022-02-02.tsv", 
                                    sep = "\t", 
                                    quote = "")

gwas_ancest_info = data.table::fread("./data/gwas_catalog/gwas_catalog-ancestry_r2022-02-02.tsv", 
                                     sep = "\t", 
                                     quote = "")

gwas_study_info = gwas_study_info |>
  dplyr::rename_all(~gsub(" ", "_", .x))

gwas_ancest_info = gwas_ancest_info |>
  dplyr::rename_all(~gsub(" ", "_", .x))

# Set up custom theme for ggplots
custom_theme <-
  list(
    theme_bw() +
      theme(
        panel.border = element_blank(),
        axis.line = element_line(),
        text = element_text(size = 16),
        legend.position = "bottom",
        strip.background = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)
      )
  )

```

## Plot figure Martin et al. 2019 like

### For all ancestries 

```{r plot_like_martin_et_al_2019_not_grouped}

# code adapted from https://github.com/armartin/prs_disparities/blob/master/gwas_disparities_time.R

# https://github.com/armartin/prs_disparities/blob/master/gwas_sfs_pop.R
# gwas cat
# http://bioconductor.org/packages/release/bioc/html/gwascat.html


# following steps from https://static-content.springer.com/esm/art%3A10.1038%2Fs41588-019-0379-x/MediaObjects/41588_2019_379_MOESM1_ESM.pdf

# wonder cdc 
# https://wonder.cdc.gov/wonder/help/QuickStart.html#
# https://wonder.cdc.gov/controller/datarequest/D76;jsessionid=2A56E973A3DF13BC5DFDD9C43725

# https://cran.r-project.org/web/packages/whomds/index.html
# whomds: Calculate Results from WHO Model Disability Survey Data


# Order GWAS catalog by date 
gwas_ancest_info <- gwas_ancest_info %>% arrange(DATE)

# calculate cumulative number of individuals
gwas_ancest_info = gwas_ancest_info %>%  
                   mutate(cum_num = cumsum(ifelse(is.na(NUMBER_OF_INDIVDUALS), 0, NUMBER_OF_INDIVDUALS))
                          )


# plot cumulative numbers
gwas_ancest_info %>%  
  group_by(DATE) %>% 
  slice_max(NUMBER_OF_INDIVDUALS) %>% 
  ggplot(aes(x=DATE,y=cum_num/1e6)) + 
  geom_line() +
  #geom_area(position = 'stack') + 
  scale_x_date(date_labels = '%Y', date_breaks = "2 years") + 
  custom_theme + 
  labs(x = "Year", y = "Individuals in GWAS catalog (millons)")

```

### Group ancestry into broader categories

```{r grouped_ancest}

group_ancestry_fn = function(study_ancest){
  
    case_when(study_ancest %in% c('Sub-Saharan African, African American or Afro-Caribbean',
                           'Sub-Saharan African, African unspecified',
                           'African-American or Afro-Caribbean') ~ 'African',
      #grouped_ancest = append(grouped_ancest,'African')
      
      
    study_ancest %in% c('East Asian, Asian unspecified', 
                                  'South Asian, East Asian ',
                                  'South Asian, South East Asian', 
                                  'South Asian, South East Asian, East Asian',
                                   'South East Asian, East Asian', 
                                  'South East Asian, South Asian, East Asian') ~'Asian unspecified',
      #grouped_ancest = append(grouped_ancest,'Asian unspecified')
      
      
    study_ancest == 'Greater Middle Eastern (Middle Eastern, North African or Persian)' ~'Middle Eastern',
      #grouped_ancest = append(grouped_ancest,'Middle Eastern')
   study_ancest %in% c('Aboriginal Australian', 'Oceanian') ~'Oceanic',
      #grouped_ancest = append(grouped_ancest,'Oceanic')
      
      
  grepl(", ", study_ancest) ~ 'Multiple',
      #grouped_ancest = append(grouped_ancest,'Multiple')
      
      
  study_ancest %in% "Hispanic or Latin American" ~'Hispanic/Latin American',
      #grouped_ancest = append(grouped_ancest,'Hispanic/Latin American')
      
      
  TRUE~study_ancest
      #grouped_ancest = append(grouped_ancest,study_ancest)
    )
  
    
  
}


grouped_ancest = vector()

for(study_ancest in unique(gwas_ancest_info$BROAD_ANCESTRAL_CATEGORY)){
  
grouped_ancest[study_ancest] = group_ancestry_fn(study_ancest)

}


# ancest_group = data.frame(group_ancest = grouped_ancest,
#                          BROAD_ANCESTRAL_CATEGORY =
#                            unique(gwas_ancest_info$BROAD_ANCESTRAL_CATEGORY))
# 
# }

grouped_ancest_map = data.frame(ancestry_group = grouped_ancest,
                                BROAD_ANCESTRAL_CATEGORY = unique(gwas_ancest_info$BROAD_ANCESTRAL_CATEGORY)
                                )

gwas_ancest_info = dplyr::left_join(
            gwas_ancest_info,
            grouped_ancest_map)

gwas_ancest_info %>% 
  group_by(ancestry_group) %>% 
  summarise(n = sum(NUMBER_OF_INDIVDUALS, na.rm = TRUE))

gwas_ancest_info %>% 
  group_by(ancestry_group) %>% 
  mutate(ancest_cumsum = cumsum(NUMBER_OF_INDIVDUALS)) %>% 
  ggplot(aes(x=DATE,y=ancest_cumsum/(10^6), fill = ancestry_group)) + 
  #geom_area() + 
  geom_area() + 
  scale_x_date(date_labels = '%Y', date_breaks = "2 years") + 
  theme_classic() + 
  labs(x = "Year", y = "Individuals in GWAS catalog (millons)") + 
  scale_fill_brewer(palette = "Set1")

inner_join(
           gwas_study_info %>% select(STUDY_ACCESSION, 
                                      `DISEASE/TRAIT`, 
                                      MAPPED_TRAIT),
           gwas_ancest_info %>% select(STUDY_ACCESSION, 
                                       NUMBER_OF_INDIVDUALS,
                                       BROAD_ANCESTRAL_CATEGORY,
                                       ancestry_group)) %>% 
  group_by(BROAD_ANCESTRAL_CATEGORY, 
           `DISEASE/TRAIT`) %>% 
  summarise(n = sum(NUMBER_OF_INDIVDUALS)) %>% 
  group_by(BROAD_ANCESTRAL_CATEGORY) %>% 
  slice_max(n,n = 5)

```

## Disease statistics CDC

```{r disease_stats_cdc, message = FALSE, warning=FALSE}


cdc_stats = data.table::fread("data/cdc/Underlying Cause of Death, 1999-2020.txt",
                              drop = c("Notes", "Race Code", "Cause of death Code")) %>% 
             filter(!if_any(everything(), ~.x == ""))

cdc_stats %>% 
  group_by(Race) %>% 
  slice_max(Deaths,n=10)


# wonder cdc 
# https://wonder.cdc.gov/wonder/help/QuickStart.html#
# https://wonder.cdc.gov/controller/datarequest/D76;jsessionid=2A56E973A3DF13BC5DFDD9C43725

# https://cran.r-project.org/web/packages/whomds/index.html
# whomds: Calculate Results from WHO Model Disability Survey Data


```
