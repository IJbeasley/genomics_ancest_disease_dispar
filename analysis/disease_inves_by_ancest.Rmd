---
title: "Disease investigated by ancestry"
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  markdown: 
    wrap: 72
---

# Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r required_fns, message = F, warning= F}

library(dplyr)
library(data.table)
library(ggplot2)
source(here::here("code/custom_plotting.R"))

```

## Load data

```{r setup_2, message = FALSE, warning= FALSE}

# gwas_study_info = data.table::fread("data/gwas_catalog/gwas-catalog-v1.0.3-studies-r2022-02-02.tsv", 
#                                     sep = "\t", 
#                                     quote = "")
 
# gwas_study_info <- fread(here::here("output/gwas_study_info_trait_corrected.csv"))

gwas_study_info <- fread(here::here("output/gwas_cat/gwas_study_info_trait_group_l2.csv"))

gwas_ancest_info <-  fread(here::here("data/gwas_catalog/gwas-catalog-v1.0.3.1-ancestries-r2025-07-21.tsv"),
                         sep = "\t", 
                         quote = "")


```

## Basic data cleaning

```{r data_cleaning}
# fixing the column names
gwas_study_info = gwas_study_info |>
  dplyr::rename_with(~ gsub(" ", "_", .x))

gwas_ancest_info = gwas_ancest_info |>
  dplyr::rename_with(~ gsub(" ", "_", .x))

# making sure arranged by DATE (oldest at the top)
gwas_ancest_info = gwas_ancest_info |> 
                   dplyr::arrange(DATE)

gwas_study_info = gwas_study_info |> 
                  dplyr::arrange(DATE)

```

## NA for number of individuals 

```{r na_number_of_individ}

# 44 studies / 44 rows
gwas_ancest_info |>
dplyr::filter(is.na(NUMBER_OF_INDIVIDUALS)) |>
nrow()

# from only 24 gwas papers
gwas_ancest_info |>
    dplyr::filter(is.na(NUMBER_OF_INDIVIDUALS)) |> 
    select(PUBMED_ID) |> 
    distinct() |>
    nrow()

gwas_ancest_info |>
  dplyr::filter(PUBMED_ID == 28679651) |>
  select(INITIAL_SAMPLE_DESCRIPTION, 
         REPLICATION_SAMPLE_DESCRIPTION, 
         BROAD_ANCESTRAL_CATEGORY) |>
  distinct()

# 28679651 - problem seems to be that number of controls per disease not specifically listed
# see https://pubmed.ncbi.nlm.nih.gov/28679651/


# although paper they cite as where data comes from (https://www.nature.com/articles/leu2016387#Tab1)
# discloses: 1229 AL amyloidosis patients from Germany, UK and Italy, and 7526 healthy local controls


```

### Filter out NA number of individuals 

```{r filter_na}

gwas_ancest_info  =
gwas_ancest_info |>
dplyr::filter(!is.na(NUMBER_OF_INDIVIDUALS))

```

## Set up - add trait information to ancestry information

```{r}

gwas_ancest_info = 
left_join(
gwas_ancest_info,
gwas_study_info |> select(STUDY_ACCESSION, 
                          COHORT, 
                          MAPPED_TRAIT,
                          DISEASE_STUDY,
                          MAPPED_TRAIT_CATEGORY,
                          BACKGROUND_TRAIT_CATEGORY,
                          l2_all_disease_terms),
by = "STUDY_ACCESSION"
)

gwas_ancest_info = gwas_ancest_info |> filter(DISEASE_STUDY == T)


```

# Top traits 

## Top traits by number of pubmed ids - including non-disease traits

The traits with the most number of pubmed ids are: 

```{r}

n_studies_trait = gwas_study_info |>
  dplyr::select(MAPPED_TRAIT, MAPPED_TRAIT_URI, PUBMED_ID) |>
  dplyr::mutate(MAPPED_TRAIT = stringr::str_split(MAPPED_TRAIT, ",\\s*")) |>
  tidyr::unnest_longer(MAPPED_TRAIT) |>
  dplyr::distinct() |>
  dplyr::group_by(MAPPED_TRAIT, MAPPED_TRAIT_URI) |>
  dplyr::summarise(n_studies = dplyr::n()) |>
  dplyr::arrange(desc(n_studies))

head(n_studies_trait)

```

## Top traits by number of pubmed ids - disease traits only


```{r}

n_studies_trait = gwas_study_info |>
  dplyr::filter(DISEASE_STUDY == T) |>
  dplyr::select(l2_all_disease_terms, PUBMED_ID) |>
  dplyr::mutate(l2_all_disease_terms = stringr::str_split(l2_all_disease_terms, ",\\s*")) |>
  tidyr::unnest_longer(l2_all_disease_terms) |>
  dplyr::distinct() |>
  dplyr::group_by(l2_all_disease_terms) |>
  dplyr::summarise(n_studies = dplyr::n()) |>
  dplyr::arrange(desc(n_studies))

head(n_studies_trait)

dim(n_studies_trait)

```


# Make ancestry groups 

Here we make the column 'ancestry_group' in the gwas_study_info datasets, 'ancestry_group' defines the broad ancestry group (like in Martin et al. 2019, European, Greater Middle Eastern etc.) that each group of individuals belongs to. 

```{r grouped_ancest}

grouped_ancest = vector()
broad_ancest_cat = unique(gwas_ancest_info$BROAD_ANCESTRAL_CATEGORY)

for(study_ancest in broad_ancest_cat){
  
grouped_ancest[study_ancest] = group_ancestry_fn(study_ancest)

}

grouped_ancest_map = data.frame(ancestry_group = grouped_ancest,
                                BROAD_ANCESTRAL_CATEGORY = broad_ancest_cat
                                )


print("See some example mappings between BROAD_ANCESTRAL_CATEGORY and ancestry_group")
print(dplyr::slice_sample(grouped_ancest_map, n = 5))


gwas_ancest_info = dplyr::left_join(
            gwas_ancest_info,
            grouped_ancest_map,
            by = "BROAD_ANCESTRAL_CATEGORY")

gwas_ancest_info = gwas_ancest_info |>
                    dplyr::mutate(ancestry_group = factor(ancestry_group, levels = ancestry_levels))



```

## Check: How many individuals in each ancestry group? 

Expecting highest to be in European

```{r n_per_ancestry_group}

total_gwas_n = 
gwas_ancest_info$NUMBER_OF_INDIVIDUALS |> sum(na.rm = T)

print("Total numbers (in millions) per ancestry group")

gwas_ancest_info |>
  dplyr::group_by(ancestry_group) |>
  dplyr::summarise(n = sum(NUMBER_OF_INDIVIDUALS, na.rm = TRUE)/10^6) |>
  dplyr::mutate(prop = n* 10^6/total_gwas_n) |>
  dplyr::arrange(desc(n)) 

```

## Plot number of individuals per ancestry group over time

```{r}

gwas_ancest_info |>
  dplyr::group_by(ancestry_group) |>
  dplyr::mutate(ancest_cumsum = cumsum(as.numeric(NUMBER_OF_INDIVIDUALS))) |>
  add_final_totals() |>
  # select(DATE, ancest_cumsum, ancestry_group, NUMBER_OF_INDIVIDUALS) |>
  ggplot(aes(x=DATE, 
             y=ancest_cumsum/(10^6), 
             fill = ancestry_group
             )
         ) + 
  geom_area(position = 'stack') + 
  scale_x_date(date_labels = '%Y', 
               date_breaks = "2 years"
               ) + 
  theme_classic() + 
  labs(x = "Year", 
       y = "Individuals in GWAS catalog (millions)") + 
  scale_fill_manual(values = ancestry_colors, name='Ancestry group')  

```

# Plot number of individuals per ancestry group for a single trait

## Select trait

```{r}

gwas_ancest_info_plot = 
gwas_ancest_info %>% 
  filter(!is.na(NUMBER_OF_INDIVIDUALS)) |>
  filter(MAPPED_TRAIT == 'high density lipoprotein cholesterol measurement')


print("Total numbers (in millions) per ancestry group - for high density lipoprotein cholesterol measurement")

gwas_ancest_info_plot %>% 
  group_by(ancestry_group) %>% 
  summarise(n = sum(NUMBER_OF_INDIVIDUALS, na.rm = TRUE)/10^6)

```


## Plot


```{r}

gwas_ancest_info_plot = 
gwas_ancest_info_plot %>% 
  group_by(ancestry_group) %>% 
  mutate(ancest_cumsum = cumsum(as.numeric(NUMBER_OF_INDIVIDUALS))) 

gwas_ancest_info_plot = add_final_totals(gwas_ancest_info_plot)

gwas_ancest_info_plot |>
  ggplot(aes(x=DATE, y=ancest_cumsum/(10^6), fill = ancestry_group)) + 
  geom_area(position = 'stack') + 
  scale_x_date(date_labels = '%Y', date_breaks = "1 years") + 
  theme_classic() + 
  labs(x = "Year", y = "Individuals in GWAS catalog (millions)") + 
  scale_fill_manual(values = ancestry_colors, name='Ancestry group') 

```


# Calculate Per Trait: Proportion European, Number of studies, Total number of individuals, Highest sample size in a single study

## Proportion European overall 

```{r}

euro_n = gwas_ancest_info |>
         filter(ancestry_group == "European") |>
         pull(NUMBER_OF_INDIVIDUALS) |>
         sum(na.rm = T)

total_n = gwas_ancest_info |>
         pull(NUMBER_OF_INDIVIDUALS) |>
         sum(na.rm = T)

100 * euro_n / total_n


```

## Proportion European per trait

```{r prop_euro_per_trait}


gwas_ancest_trait_info = gwas_ancest_info |> 
  dplyr::filter(DISEASE_STUDY == T) |>
  dplyr::select(l2_all_disease_terms, 
                PUBMED_ID, ancestry_group, NUMBER_OF_INDIVIDUALS) |>
  dplyr::mutate(l2_all_disease_terms = stringr::str_split(l2_all_disease_terms, ",\\s*")) |>
  tidyr::unnest_longer(l2_all_disease_terms) |>
  dplyr::distinct()

n_studies_trait = n_studies_trait |> 
                  dplyr::filter(n_studies > 2) |>
                  dplyr::filter(l2_all_disease_terms != "")

total_n_euro_vec = vector()
prop_euro_vec = vector()
med_prop_euro_vec = vector()
first_quartile_prop_euro_vec = vector()
total_n_vec = vector()
med_sample_size_vec = vector()
n_studies_vec = vector()
highest_sample_size_vec = vector()

for(trait in n_studies_trait$l2_all_disease_terms){
  
  # Calculate the number of European ancestry individuals (studied for this trait)
  total_euro_n = gwas_ancest_trait_info |>
                 filter(ancestry_group == "European") |>
                 filter(l2_all_disease_terms %in% trait) |>
                 pull(NUMBER_OF_INDIVIDUALS) |>
                 sum(na.rm = T)
  
  total_n_euro_vec[trait] = total_euro_n
  
  # Calculate the total number of individuals (studied for this trait)
  all_study_n = gwas_ancest_trait_info |>
                filter(l2_all_disease_terms %in% trait) |>
                pull(NUMBER_OF_INDIVIDUALS) 
  
  total_n  = all_study_n |>
             sum(na.rm = T)
  
  total_n_vec[trait] = total_n
  
  # Get the highest sample size in a single study (for this trait)
  highest_sample_size = max(all_study_n, na.rm = T)
  
  highest_sample_size_vec[trait] = highest_sample_size
  
  # Get the median sample size in a single study (for this trait)
  med_sample_size_vec[trait] = median(all_study_n, na.rm = T)
  
  # Calculate the proportion of European ancestry individuals (across all studies for this trait)
  prop_euro_vec[trait] = 100 * total_euro_n / total_n
  
  # Calculate the number of unique studies (pubmed ids) for this trait
  n_studies = gwas_ancest_trait_info |>
              filter(l2_all_disease_terms %in% trait) |>
              pull(PUBMED_ID) |>
              unique() |>
              length()
  
  n_studies_vec[trait] = n_studies
  
  # Calculate the proportion of European ancestry individuals (per study for this trait)
  euro_n_per_study = gwas_ancest_trait_info |>
            filter(ancestry_group == "European") |>
            filter(l2_all_disease_terms %in% trait) |>
            group_by(PUBMED_ID) |>
            summarise(n_euro = sum(NUMBER_OF_INDIVIDUALS, na.rm = T))
  
  
  total_n_per_study = gwas_ancest_trait_info |>
            filter(l2_all_disease_terms %in% trait) |>
            group_by(PUBMED_ID) |>
            summarise(n_total = sum(NUMBER_OF_INDIVIDUALS, na.rm = T))
  
  prop_euro_per_study = inner_join(euro_n_per_study,
                                   total_n_per_study,
                                   by = "PUBMED_ID") |>
                         mutate(prop_euro = 100 * n_euro / n_total) 
  
  med_prop_euro_vec[trait] = median(prop_euro_per_study$prop_euro, na.rm = T)
  
  first_quartile_prop_euro_vec[trait] = quantile(prop_euro_per_study$prop_euro, probs = 0.25, na.rm = T)
  
}

prop_euro_df = data.frame(trait = n_studies_trait$l2_all_disease_terms,
                          total_n = total_n_vec,
                          total_n_euro = total_n_euro_vec,
                         prop_euro = prop_euro_vec,
                          median_prop_euro = med_prop_euro_vec,
                          n_studies = n_studies_vec,
                          highest_sample_size = highest_sample_size_vec,
                          median_sample_size = med_sample_size_vec,
                         first_quartile_prop_euro = first_quartile_prop_euro_vec
                          )

```


```{r}

prop_euro_df |> ungroup() |> dplyr::slice_min(prop_euro, n = 10)

prop_euro_df |> ungroup() |> dplyr::slice_max(prop_euro, n = 10)

prop_euro_df |> ungroup() |> dplyr::slice_max(total_n, n = 5)

```

# Plot variation across disease traits: 

## Distribution plots 

### Number of studies and sample size 

#### Averaege number of individuals per study (for each disease)

```{r}

prop_euro_df = prop_euro_df |>
  dplyr::mutate(avg_n_per_study = total_n / n_studies)

print("Average number of individuals per study (for this trait) - in millions")
c(prop_euro_df$avg_n_per_study / 10^6) |> summary()

prop_euro_df |>
  ggplot(aes(x = avg_n_per_study)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(x = "Average number of individuals per study (for this trait)")

```

### Total number of individuals (per disease trait)

```{r}
print("Total number of individuals (studied for each trait) - in millions")
c(prop_euro_df$total_n / 10^6) |> summary()

prop_euro_df |>
  ggplot(aes(x = total_n)) + 
  geom_histogram() + 
  theme_bw() + 
  scale_x_continuous(labels = scales::label_log()) + 
  labs(x = "Total number of GWAS participants for each trait")


prop_euro_df |>
  mutate(total_n = log10(total_n)) |>
  ggplot(aes(x = total_n)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(x = "log10(total number of GWAS participants for each trait)") 
```

#### Number of European individuals (per disease trait)

```{r}

print("Number of European ancestry individuals (studied for each trait) - in millions")
c(prop_euro_df$total_n_euro / 10^6) |> summary()

prop_euro_df |>
  ggplot(aes(x = total_n_euro)) + 
  geom_histogram() +
  theme_bw() +
  scale_x_continuous(labels = scales::label_log()) +
  labs(x = "Number of European ancestry individuals (studied for each trait)")

```

#### Highest sample size in a single study (per disease trait)

```{r}

print("Highest sample size in a single study (for this trait) - in millions")
c(prop_euro_df$highest_sample_size / 10^6) |> summary()

prop_euro_df |>
  ggplot(aes(x = highest_sample_size)) + 
  geom_histogram() + 
  theme_bw() + 
  scale_x_continuous(labels = scales::label_log()) + 
  labs(x = "Highest sample size in a single study (for this trait)")


```

### Proportion european

#### Distribution of proportion european 

```{r}

print("Proportion European ancestry individuals (studied for each trait)")
prop_euro_df$prop_euro |> summary()

prop_euro_df |>
  ggplot(aes(x = prop_euro)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(x = "Proportion of European ancestry individuals (studied for each trait)")

```


#### Distribution of median proportion european (per study, per disease trait)

```{r}

print("Median proportion European ancestry individuals (per study, for each trait)")
prop_euro_df$median_prop_euro |> summary()

prop_euro_df |>
  ggplot(aes(x = median_prop_euro)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(x = "Median proportion of European ancestry individuals (per study, for each trait)")


```

#### Distribution of first quartile proportion european (per study, per disease trait)

```{r}

print("First quartile proportion European ancestry individuals (per study, for each trait)")
prop_euro_df$first_quartile_prop_euro |> summary()

prop_euro_df |>
  ggplot(aes(x = first_quartile_prop_euro)) + 
  geom_histogram() + 
  theme_bw() + 
  labs(x = "First quartile proportion of European ancestry individuals (per study, for each trait)")


```


## Scatter plots against number and proportion European 

```{r}

third_quartile_prop = quantile(prop_euro_df$prop_euro, probs = 0.75)

first_quartile_prop = quantile(prop_euro_df$prop_euro, probs = 0.25)

fifth_percentile_prop = quantile(prop_euro_df$prop_euro, probs = 0.05)


```

### Proportion european - vs. total number of individuals 

```{r}

print("Proportion European vs. total number of individuals - spearman correlation")
cor(prop_euro_df$prop_euro, prop_euro_df$total_n, 
    method = "spearman",
    use = "pairwise.complete.obs")


print("Proportion European vs. total number of individuals - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(prop_euro, total_n,   
                      method = "spearman",
    use = "pairwise.complete.obs"))

plot = 
prop_euro_df |>
  ggplot(aes(x = total_n, y = prop_euro, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
  scale_x_log10(labels = scales::label_log(),
                limits = c(min(prop_euro_df$total_n), max(prop_euro_df$total_n) * 1.1)) +
  geom_hline(yintercept = third_quartile_prop, linetype="dashed", color = "red") +
  geom_hline(yintercept = first_quartile_prop, linetype="dashed", color = "blue") +
  geom_hline(yintercept = fifth_percentile_prop, linetype="dashed", color = "purple") +
  annotate("text", x = max(prop_euro_df$total_n) - 10^3, y = third_quartile_prop + 1,
           label = "3rd quart.", vjust = -0.5, hjust = 1, color = "red") +
  annotate("text", x = max(prop_euro_df$total_n) - 10^3, y = first_quartile_prop + 1,
           label = "1st quart.", vjust = -0.5, hjust = 1, color = "blue") +
  annotate("text", x = max(prop_euro_df$total_n) -10^3, y = fifth_percentile_prop + 1,
           label = "5th percent.", vjust = -0.5, hjust = 1, color = "purple") +
  labs(x = "Total number of individuals (studied for this trait)",
       y = "% European ancestry idividuals (studied for this trait)")


plotly::ggplotly(plot)

```

### Number of European individuals - vs. total number of individuals

```{r}

print("Number of European ancestry individuals vs. total number of individuals - spearman correlation")
cor(prop_euro_df$total_n_euro, prop_euro_df$total_n, 
    method = "spearman",
    use = "pairwise.complete.obs")

print("Number of European ancestry individuals vs. total number of individuals - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(total_n_euro, total_n,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = total_n, y = total_n_euro, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
  scale_x_continuous(labels = scales::label_log()) +
  scale_y_continuous(labels = scales::label_log()) +
  labs(x = "Total number of individuals (studied for this trait)",
       y = "Number of European ancestry idividuals (studied for this trait)") + 
  geom_abline(slope = 1, intercept = 0, linetype="dashed", color = "red")

plotly::ggplotly(plot)

```

### Proportion european - vs. number of studies

```{r}

print("Proportion European vs. number of studies - spearman correlation")
cor(prop_euro_df$prop_euro, prop_euro_df$n_studies, 
    method = "spearman",
    use = "pairwise.complete.obs")


print("Proportion European vs. number of studies - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(prop_euro, n_studies,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = n_studies, y = prop_euro)) + 
  geom_point() + 
  theme_bw() + 
  scale_x_log10(labels = scales::label_log()) +
  labs(x = "Total number of unique PUBMED IDs for this trait",
       y = "Proportion of European ancestry idividuals (studied for this trait)")


plotly::ggplotly(plot)

```

### Number of European individuals vs number of studies

```{r}

print("Number of European ancestry individuals vs. number of studies - spearman correlation")
cor(prop_euro_df$total_n_euro, prop_euro_df$n_studies, 
    method = "spearman",
    use = "pairwise.complete.obs")


prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(total_n_euro, n_studies,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = total_n_euro, y = n_studies, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
#  scale_x_continuous(labels = scales::label_log()) +
  labs(x = "Number of European ancestry idividuals (studied for this trait)",
       y = "Total number of unique PUBMED IDs for this trait")


plotly::ggplotly(plot)

```

### First quartile proportion european vs number of studies

```{r}

cor(prop_euro_df$first_quartile_prop_euro, prop_euro_df$n_studies, 
    method = "spearman",
    use = "pairwise.complete.obs")


prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(first_quartile_prop_euro, n_studies,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = n_studies, y = first_quartile_prop_euro, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
  scale_x_log10(labels = scales::label_log()) +
  labs(x = "Total number of unique PUBMED IDs for this trait",
       y = "First quartile proportion of European ancestry idividuals (studied for this trait)")


plotly::ggplotly(plot)


```

### First quartile proportion european vs total number of individuals

```{r}

print("First quartile proportion European vs. total number of individuals - spearman correlation")
cor(prop_euro_df$first_quartile_prop_euro, prop_euro_df$total_n, 
    method = "spearman",
    use = "pairwise.complete.obs")


print("First quartile proportion European vs. total number of individuals - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(first_quartile_prop_euro, total_n,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )


plot =
prop_euro_df |>
  ggplot(aes(x = total_n, y = first_quartile_prop_euro, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
  scale_x_log10() + 
  labs(x = "Total number of individuals (studied for this trait)",
       y = "First quartile proportion of European ancestry idividuals (studied for this trait)")


plotly::ggplotly(plot)

```

### Number of individuals vs number of studies

```{r}

print("Total number of individuals vs. number of studies - spearman correlation")
cor(prop_euro_df$total_n, prop_euro_df$n_studies, 
    method = "spearman",
    use = "pairwise.complete.obs")

print("Total number of individuals vs. number of studies - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(total_n, n_studies,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = total_n, y = n_studies, diseae = trait)) + 
  geom_point() + 
  theme_bw() + 
  labs(x = "Total number of individuals (studied for this trait)",
       y = "Total number of unique PUBMED IDs for this trait")


plotly::ggplotly(plot)

```




### Proportion european - vs. average number of individuals per study

```{r}

print("Proportion European vs. average number of individuals per study - spearman correlation")
cor(prop_euro_df$prop_euro, prop_euro_df$avg_n_per_study, 
    method = "spearman",
    use = "pairwise.complete.obs")

print("Proportion European vs. average number of individuals per study - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(prop_euro, avg_n_per_study,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = avg_n_per_study, y = prop_euro, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
  labs(x = "Average number of individuals per study (for this trait)",
       y = "Proportion of European ancestry idividuals (studied for this trait)")

plotly::ggplotly(plot)

```


### Number of studies vs average number of individuals per study

```{r}

print("Total number of studies vs. average number of individuals per study - spearman correlation")
cor(prop_euro_df$n_studies, prop_euro_df$avg_n_per_study, 
    method = "spearman",
    use = "pairwise.complete.obs")

print("Total number of studies vs. average number of individuals per study - spearman correlation - only traits with > 5 studies")
prop_euro_df |>
  filter(n_studies > 5) |>
  summarise(cor = cor(n_studies, avg_n_per_study,   
                      method = "spearman",
    use = "pairwise.complete.obs")
    )

plot = 
prop_euro_df |>
  ggplot(aes(x = n_studies, y = avg_n_per_study, disease = trait)) + 
  geom_point() + 
  theme_bw() + 
  labs(x = "Total number of unique PUBMED IDs for this trait",
       y = "Average number of individuals per study (for this trait)")

plotly::ggplotly(plot)

```


# Disease statistics GBD

```{r gbd_stats}

gbd_data <- data.table::fread(here::here("data/gbd/ihme_gbd_2019_global_disease_burden_rate_all_ages.csv"))

```

## Total number of individuals vs global DALYs

```{r}

compare_stats =
left_join(prop_euro_df |> rename(cause = trait),
          gbd_data |> mutate(cause = tolower(cause))
)

cor(compare_stats$total_n, 
    compare_stats$val, 
    method = "spearman",
    use = "pairwise.complete.obs"
)

plot = 
compare_stats |>
  ggplot(aes(y = total_n, x = val, trait = cause)) + 
  geom_point() + 
  theme_bw() + 
  scale_y_log10(labels = scales::label_log())  +
  scale_x_log10(labels = scales::label_log()) +
  labs(y = "Total number of individuals (studied for this trait)",
       x = "Global DALYs (2019, GBD)")

plotly::ggplotly(plot)

```

## Largest sample size vs global DALYs

```{r}

cor(compare_stats$highest_sample_size, 
    compare_stats$val, 
    method = "spearman",
    use = "pairwise.complete.obs"
)


plot = compare_stats |>
  ggplot(aes(y = highest_sample_size, 
             x = val, 
             trait = cause)) + 
  geom_point() + 
  scale_y_log10(labels = scales::label_log())  +
  scale_x_log10(labels = scales::label_log()) +
  theme_bw() + 
  labs(y = "Largest sample size in a single study (for this trait)",
       x = "Global DALYs (2019, GBD)")

plotly::ggplotly(plot)

```

## Number of studies vs global DALYs

```{r}

cor(compare_stats$n_studies, 
    compare_stats$val, 
    method = "spearman",
    use = "pairwise.complete.obs"
)

plot = compare_stats |>
  ggplot(aes(y = n_studies, 
             x = val, 
             trait = cause)) + 
  geom_point() + 
  scale_y_log10(labels = scales::label_log())  +
  scale_x_log10(labels = scales::label_log()) +
  theme_bw() + 
  labs(y = "Total number of studies (for this trait)",
       x = "Global DALYs (2019, GBD)")

plotly::ggplotly(plot)

```
