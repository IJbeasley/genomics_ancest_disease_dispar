---
title: "Matching GWAS traits to GBD causes / diseases"
author: "Isobel Beasley"
date: "2025-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up

```{r load_libraries, message=FALSE}

library(dplyr)
library(stringr)
library(purrr)
library(tidyr)
library(data.table)

```

## Load Lancet priority diseases

```{r load_lancet_priority_diseases}

gbd_2019 <- readxl::read_xlsx(here::here("data/icd/lancet_conditions_icd10.xlsx"))

gbd_2019 =
  gbd_2019 |>
  select(cause = mapped_gbd_term,
         icd10 = icd_10_non_fatal,
         cause_hierarchy_level = gbd_level)


gbd_2019 =
  gbd_2019 |>
  filter(!is.na(icd10))

```


# Prepare GBD 2019 data for merging with GWAS traits

## Tidy ICD codes

### Make long format, separate multiple ICD code ranges into rows

```{r make_long_icd10_2019}

# expand multiple ICD codes into rows
gbd_2019 = 
  gbd_2019 |>
  mutate(icd10 = str_split(icd10, ",\\s*")) |>
  tidyr::unnest(icd10) 

# separate ICD code ranges into start and end codes
gbd_2019 =
  gbd_2019 |>
  tidyr::separate_wider_delim(col = "icd10",
                        delim = "-", 
                       names = c("start_icd10_code", "end_icd10_code"),
                       too_few = "align_end"
                       ) 

# if only one ICD code (i.e. no range), set start and end to be the same
gbd_2019 =
  gbd_2019 |>
  mutate(start_icd10_code = 
         ifelse(is.na(start_icd10_code),
                end_icd10_code,
                start_icd10_code)
         )

gbd_2019 =
  gbd_2019 |>
  distinct()

head(gbd_2019)

```

### Where icd10 code ranges are the same, but missing decimal places, add .9 to end code (to help with filtering ranges)

```{r}

gbd_2019 |>
  filter(start_icd10_code == end_icd10_code &
         !grepl(".", start_icd10_code, fixed = TRUE)
         ) |>
  arrange(start_icd10_code) |>
  head()

gbd_2019 = 
gbd_2019 |>
  mutate(end_icd10_code =
         ifelse(
         start_icd10_code == end_icd10_code &
         !grepl(".", start_icd10_code, fixed = TRUE),
         paste0(end_icd10_code, ".9"),
         end_icd10_code
         ) 
  )

```

### Seperate numeric and letter parts of ICD codes (to help with filtering ranges)

```{r separate_numeric_letter_icd10_2019}

# replace O9A513 with O99.9
gbd_2019 =
  gbd_2019 |>
  mutate(end_icd10_code =
        ifelse(end_icd10_code == "O9A513",
               "O99.9",
               end_icd10_code)
         )

# replace Z3A49 with Z39.2
gbd_2019 =
  gbd_2019 |>
  mutate(end_icd10_code =
        ifelse(end_icd10_code == "Z3A49",
               "Z39.2",
               end_icd10_code)
         )

# check start_icd10_code and end_icd10_code start with the same letter
# if not, need to fix these rows
  gbd_2019 |>
  filter(str_extract(start_icd10_code, "^[A-Z]") != 
         str_extract(end_icd10_code, "^[A-Z]")
         )

gbd_2019 =
  gbd_2019 |>
  mutate(icd10_code_letter = str_extract(start_icd10_code, "^[A-Z]")) 

gbd_2019 =
  gbd_2019 |>
  mutate(start_icd10_code_num = as.numeric(str_remove(start_icd10_code, 
                                                      "^[A-Z]")
                                           ),
         end_icd10_code_num = as.numeric(str_remove(end_icd10_code, 
                                                    "^[A-Z]")
                                         )
         )

```



# Merge GWAS traits with GBD causes

## Load Disease Mapping 

```{r load_gwas_study_info}

disease_mapping <- data.table::fread(
here::here("output/icd_map/gwas_disease_to_icd10_mapping.csv")
)

disease_mapping =
  disease_mapping |>
  mutate(icd10_code = sub("^([^-]+)-\\1$", "\\1", icd10_code))

disease_mapping =
  disease_mapping |>
    mutate(icd10_code_letter = str_extract(icd10_code, "^[A-Z]")) |>
    mutate(icd10_code_num = as.numeric(str_remove(icd10_code, "^[A-Z]")))

disease_mapping |>
  filter(is.na(icd10_code_num)) |>
  nrow()

disease_mapping =
  disease_mapping |>
  filter(!is.na(icd10_code_num)) 

disease_mapping = 
  disease_mapping |>
  mutate(icd10_code_num = as.numeric(icd10_code_num))

```

## Join disease mapping with GBD 2019 data

```{r join_gwas_gbd_2019}

disease_mapping_with_cause <- disease_mapping |>
  rowwise() |>
  mutate(
    cause = 
      list(
      gbd_2019$cause[
      which(icd10_code_num >= gbd_2019$start_icd10_code_num &
            icd10_code_num <= gbd_2019$end_icd10_code_num & 
            icd10_code_letter == gbd_2019$icd10_code_letter)
      ]),
    cause_hierarchy_level  = 
       list(
            gbd_2019$cause_hierarchy_level[
      which(icd10_code_num >= gbd_2019$start_icd10_code_num &
            icd10_code_num <= gbd_2019$end_icd10_code_num & 
            icd10_code_letter == gbd_2019$icd10_code_letter)
      ])
  ) |>
  ungroup()


disease_mapping_with_cause = 
  disease_mapping_with_cause |>
  tidyr::unnest(c(cause, cause_hierarchy_level),
                keep_empty = TRUE
                )


```

### Checking hierarchy levels

```{r check_hierarchy_levels}

disease_mapping_with_cause = 
  disease_mapping_with_cause |>
  filter(!is.na(cause))

# filtering na to deal with pivoting 
# disease_mapping_with_cause_grouped = 
# disease_mapping_with_cause |>
# select(-icd10_code_num) |>
# tidyr::pivot_wider(
#             id_cols = c("collected_all_disease_terms", 
#                         "icd10_code", 
#                         "icd10_description"),
#             names_from = cause_hierarchy_level, 
#             names_glue = "l{.name}_{.value}",
#             values_from = cause,
#             values_fn = ~str_flatten(unique(.x), collapse = ", ", na.rm = TRUE)
#             )


```

```{r fill_in_l2_causes}

# check which l2 causes are NA but l3 causes are not NA
# can use l3 causes therefore to fill in l2 causes
# disease_mapping_with_cause_grouped |> 
#   rowwise() |> 
#   filter(is.na(l2_cause) & !is.na(l3_cause)) |>
#   head()
# 
# neoplasms = c("Other neoplasms", 
#                                     "Hodgkin lymphoma",
#                                     "Leukemia",
#                                     "Non-Hodgkin lymphoma",
#               "Multiple myeloma")
# 
# disease_mapping_with_cause_grouped = 
#   disease_mapping_with_cause_grouped |>
#   rowwise() |>
#   mutate(l2_cause = 
#            list(ifelse(is.na(l2_cause),
#                   case_when(map_lgl(l3_cause, ~ .x %in% neoplasms) ~ "Neoplasms",
#                             map_lgl(l3_cause, ~ .x %in% "Neonatal disorders") ~ "Maternal and neonatal disorders",
#                             map_lgl(l3_cause, ~ .x %in% "Other cardiovascular and circulatory diseases") ~ "Cardiovascular diseases"
#                             ),
#                   l2_cause
#            )
#            )) |>
#   ungroup()
          

# to_map_manually <- 
# disease_mapping_with_cause_grouped |> 
#   rowwise() |> 
#   filter(is.null(l2_cause)) |> 
#   pull(collected_all_disease_terms) |> 
#   unique()
# 
# 
# update_unmapped_cause = function(df, 
#                                  unmapped_term, 
#                                  l2_cause_rep, 
#                                  l3_cause_rep){
#   
#   df = 
#   df |>
#     mutate(l3_cause = 
#            ifelse(collected_all_disease_terms == unmapped_term,
#                   l3_cause_rep,
#                   l3_cause
#            )) |>
#     mutate(l2_cause = 
#            ifelse(collected_all_disease_terms == unmapped_term,
#                   l2_cause_rep,
#                   l2_cause
#            ))    
#            
#     return(df)
#            
# }
# 
# disease_mapping_with_cause_grouped = 
# update_unmapped_cause(disease_mapping_with_cause_grouped, 
#                       "bone cancer",
#                       "Neoplasms",
#                       "Malignant neoplasms of bone and articular cartilage")


```

# Save + combine with GWAS data

```{r save_final_gwas_gbd_mapping}

# disease_mapping_orig <- data.table::fread(
# here::here("output/icd_map/gwas_disease_to_icd10_mapping.csv")
# )
# 
# disease_mapping_with_cause_grouped =
#   disease_mapping_with_cause_grouped |>
#   tidyr::unnest_longer(c("l3_cause", "l4_cause")) 

disease_mapping_final =  disease_mapping_with_cause
  # left_join(
  #   disease_mapping_orig,
  #   disease_mapping_with_cause,
  #   by = c("collected_all_disease_terms", 
  #          "icd10_code", 
  #          "icd10_description")
  # )

# gwas_study_info <- fread(here::here("output/gwas_cat/gwas_study_info_group_v2.csv"))
# 
# gwas_study_info =
#   gwas_study_info |>
#   select(`DISEASE/TRAIT`, PUBMED_ID, STUDY_ACCESSION, COHORT)
# 
# disease_mapping_final =
#   left_join(
#     disease_mapping_final,
#     gwas_study_info
#   )


# disease_mapping_final = 
#   disease_mapping_final |>
#   group_by(STUDY_ACCESSION, collected_all_disease_terms) |>
#   summarise(
#     PUBMED_ID = paste0(unique(PUBMED_ID), collapse = "; "),
#     COHORT = paste0(unique(COHORT), collapse = "; "),
#     icd10_code = paste0(unique(icd10_code), collapse = "; "),
#     icd10_description = paste0(unique(icd10_description), collapse = "; "),
#     # l2_cause = str_flatten(unique(str_split(l2_cause, ", ")), # add separation step here ... 
#     #                        collapse = "; ", na.rm = TRUE),
#     l3_cause = str_flatten(unique(str_split(l3_cause, ", ")), 
#                            collapse = "; ", na.rm = TRUE),
#     l4_cause = str_flatten(unique(str_split(l4_cause, ", ")), 
#                            collapse = "; ", na.rm = TRUE)
#   ) 

data.table::fwrite(
# disease_mapping_final,
disease_mapping_with_cause,
here::here("output/icd_map/gwas_study_gbd_causes.csv")
)

```


