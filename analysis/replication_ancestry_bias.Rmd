---
title: "Replicate observed ancestry biases figures in GWAS dataset"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup_packages, message = FALSE, warning= FALSE}

library(dplyr)
library(ggplot2)
library(data.table)
source(here::here("code/custom_plotting.R"))

```

## Load GWAS catalog data

```{r setup_2, message = FALSE, warning= FALSE}

gwas_study_info <- fread(here::here("output/gwas_study_info_trait_ontology_info.csv"))

gwas_ancest_info <-  fread(here::here("data/gwas_catalog/gwas-catalog-v1.0.3.1-ancestries-r2025-07-21.tsv"),
                         sep = "\t", 
                         quote = "")

gwas_study_info = gwas_study_info |>
  dplyr::rename_all(~gsub(" ", "_", .x))

gwas_ancest_info = gwas_ancest_info |>
  dplyr::rename_all(~gsub(" ", "_", .x))

gwas_ancest_info = gwas_ancest_info |>
                    arrange(DATE)

gwas_study_info = gwas_study_info |>
                  arrange(DATE)

```

## Studies with missing sample numbers 

```{r}

# Some number of individuals are missing

# 44 studies / 44 rows
gwas_ancest_info |>
dplyr::filter(is.na(NUMBER_OF_INDIVIDUALS)) |>
nrow()

gwas_ancest_info |> 
  dplyr::filter(is.na(NUMBER_OF_INDIVIDUALS) | NUMBER_OF_INDIVIDUALS == 0) |> 
  nrow()

gwas_ancest_info |> 
  dplyr::filter(is.na(NUMBER_OF_INDIVIDUALS) | NUMBER_OF_INDIVIDUALS == 0) |> 
  head()


# from only 24 gwas papers
gwas_ancest_info |>
    dplyr::filter(is.na(NUMBER_OF_INDIVIDUALS)) |> 
    select(PUBMED_ID) |> 
    distinct() |>
    nrow()

gwas_ancest_info |>
  dplyr::filter(PUBMED_ID == 28679651) |>
  select(INITIAL_SAMPLE_DESCRIPTION, 
         REPLICATION_SAMPLE_DESCRIPTION, 
         BROAD_ANCESTRAL_CATEGORY) |>
  distinct()

# 28679651 - problem seems to be that number of controls per disease not specifically listed
# see https://pubmed.ncbi.nlm.nih.gov/28679651/


# although paper they cite as where data comes from (https://www.nature.com/articles/leu2016387#Tab1)
# discloses: 1229 AL amyloidosis patients from Germany, UK and Italy, and 7526 healthy local controls


# Filter missing number of individuals
gwas_ancest_info = gwas_ancest_info |>
  dplyr::filter(!is.na(NUMBER_OF_INDIVIDUALS)) |>
  dplyr::filter(NUMBER_OF_INDIVIDUALS != 0)


```

# Plot figure Martin et al. 2019 like

### For all ancestries - number of individuals in the GWAS catalog over time

```{r plot_like_martin_et_al_2019_not_grouped}

# code adapted from https://github.com/armartin/prs_disparities/blob/master/gwas_disparities_time.R

# https://github.com/armartin/prs_disparities/blob/master/gwas_sfs_pop.R
# gwas cat
# http://bioconductor.org/packages/release/bioc/html/gwascat.html

# following steps from https://static-content.springer.com/esm/art%3A10.1038%2Fs41588-019-0379-x/MediaObjects/41588_2019_379_MOESM1_ESM.pdf

# calculate cumulative number of individuals
gwas_ancest_info = gwas_ancest_info %>%  
                   dplyr::arrange(DATE) |>
                   mutate(cum_num = cumsum(as.numeric(NUMBER_OF_INDIVIDUALS)))


# plot cumulative numbers
gwas_ancest_info %>%  
  # group_by(DATE) %>% 
  # slice_max(NUMBER_OF_INDIVDUALS) %>% 
  ggplot(aes(x=DATE,y=cum_num/1e6)) + 
 # geom_line() +
  geom_area() + 
  scale_x_date(date_labels = '%Y', date_breaks = "2 years") + 
  custom_theme + 
  labs(x = "Year", 
       y = "Individuals in GWAS catalog (millons)")

```


## Make ancestry groups 

Here we make the column 'ancestry_group' in the gwas_study_info datasets, 'ancestry_group' defines the broad ancestry group (like in Martin et al. 2019, European, Greater Middle Eastern etc.) that each group of individuals belongs to. 

```{r grouped_ancest}


grouped_ancest = vector()
broad_ancest_cat = unique(gwas_ancest_info$BROAD_ANCESTRAL_CATEGORY)

for(study_ancest in broad_ancest_cat){
  
grouped_ancest[study_ancest] = group_ancestry_fn(study_ancest)

}

grouped_ancest_map = data.frame(ancestry_group = grouped_ancest,
                                BROAD_ANCESTRAL_CATEGORY = broad_ancest_cat
                                )


print("Mapping examples - broad ancestral categories to ancestry groups")
head(grouped_ancest_map)

gwas_ancest_info = dplyr::left_join(
            gwas_ancest_info,
            grouped_ancest_map,
            by = "BROAD_ANCESTRAL_CATEGORY")

gwas_ancest_info = gwas_ancest_info |>
                    dplyr::mutate(ancestry_group = factor(ancestry_group, levels = ancestry_levels))


```

## Number of individuals per ancestry group (in millions)

```{r}

gwas_ancest_info %>% 
  dplyr::group_by(ancestry_group) %>% 
  dplyr::summarise(n = sum(NUMBER_OF_INDIVIDUALS, na.rm = TRUE)/ 10^6)

```

### Make plot like Martin et al. 2019 by applying this ancestry mapping - number of individuals in GWAS catalog over time, per ancestry group

```{r}

# Define the desired stacking order
gwas_ancest_info = 
gwas_ancest_info %>% 
  mutate(ancestry_group = factor(ancestry_group, levels = ancestry_levels)) %>%
  group_by(ancestry_group) %>% 
  mutate(ancest_cumsum = cumsum(as.numeric(NUMBER_OF_INDIVIDUALS))) %>% 
  add_final_totals() 


gwas_ancest_info |> 
  ggplot(aes(x=DATE, y=ancest_cumsum/(10^6), fill = ancestry_group)) + 
  geom_area(position = 'stack') + 
  scale_x_date(date_labels = '%Y', date_breaks = "2 years") + 
  theme_classic() + 
  labs(x = "Year", y = "Individuals in GWAS catalog (millons)") + 
  scale_fill_manual(values = ancestry_colors, name='Ancestry group') 


```

